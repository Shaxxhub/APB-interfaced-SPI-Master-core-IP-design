# APB-interfaced-SPI-Master-core-IP-design

In modern embedded systems and SoC (System-on-Chip) designs, efficient and reliable communication between the processor and peripheral devices is essential. Serial Peripheral Interface (SPI) is a popular synchronous serial communication protocol used for short-distance communication due to its high speed and simplicity. It is commonly used to interface microcontrollers with external devices such as sensors, memory chips, ADCs, DACs, and display controllers. Unlike asynchronous protocols, SPI uses a master-slave architecture with dedicated lines for clock (SCLK), data transmission (MOSI), data reception (MISO), and slave selection (SS). SPI enables full-duplex communication, allowing simultaneous data transfer between the master and slave, controlled by a serial clock generated by the master. This project focuses on the design and Verilog implementation of an SPI Master IP Core that can be integrated into digital systems using an APB (Advanced Peripheral Bus) interface. The SPI Master core supports key features such as configurable clock polarity and phase, programmable baud rate, MSB/LSB-first transmission, multiple slave support, automatic slave selects, and interrupt generation. The implementation is modular, consisting of key blocks such as the baud rate generator, APB slave interface, shift register, and SPI control logic. Simulation and verification are performed using Intel Modelsim and Quartus prime to ensure the correct functionality of the design, making it suitable for integration in real-time VLSI and embedded applications. 

SPI Core Architecture
The SPI Master IP Core is designed to enable high-speed, full-duplex communication between a processor and SPI-compatible peripherals. It follows a modular architecture, where each sub-block is responsible for a specific function, enabling better design clarity, maintainability, and verification.
The architecture consists of the following major components:

1. APB Slave Interface
The APB Slave Interface serves as the bridge between the SPI controller and the processor system through the AMBA 3 APB protocol. This interface decodes incoming APB transactions by interpreting signals including PADDR, PSEL, PENABLE, PWRITE, PWDATA, and PREADY to orchestrate internal SPI operations. Functioning as the primary configuration and control gateway, it enables the processor to configure SPI parameters through register writes (such as clock polarity CPOL, clock phase CPHA, master mode MSTR, and bit order LSBFE), initiate data transfers by writing to the transmit register, and retrieve operational status along with received data through read operations

2. Baud Rate Generator
The SPI clock generation circuit produces SCLK by dividing down the system clock through a configurable baud rate divisor mechanism. This implementation employs a cascaded pre-scaler and counter arrangement to achieve the desired clock division ratio, with the SPI_BR register providing dynamic control over the divisor value. The resulting SCLK signal drives the data shifting operations for both master and slave devices throughout the communication exchange, enabling support for a broad spectrum of operating frequencies to accommodate various system requirements.

3. Shift Register
The shift register serves as the core component for SPI data handling, performing bidirectional serial-to-parallel conversion. It transforms parallel data from the APB interface into a serial bitstream transmitted via MOSI, while simultaneously capturing incoming serial data from MISO and reconstructing it into parallel format. The register supports configurable bit ordering (MSB-first or LSB-first) and operates in lockstep with the SPI clock signal. Data transmission initiates upon assertion of the send_data signal and concludes after N clock cycles, where N corresponds to the programmed data width (8, 16, or other configured values).

4. SPI Slave Control Logic
The SPI Slave Control Logic coordinates the operational flow of SPI transactions through several key management functions. It oversees Slave Select (SS) signal generation to initiate communication sequences and implements CPOL/CPHA logic to enable compatibility with all four SPI communication modes. The control block tracks active transmission states via the TIP (Transfer in Progress) flag while monitoring completion indicators such as transmission finished and shift operation status. It also manages the assertion of receive_data and interrupt_request signals, guaranteeing that data sampling occurs on the appropriate clock transitions according to the selected SPI mode configuration for both transmitted and received data.

5. Top-Level SPI Module
This module integrates all the above blocks. It:
•	Receives configuration/control signals from the APB slave interface
•	Manages internal coordination among the clock, shift, and control modules
•	Interfaces directly with external SPI lines: MOSI, MISO, SCLK, and SS

<img width="889" height="742" alt="image" src="https://github.com/user-attachments/assets/7ddfa05b-bcae-488c-8411-dec56e804498" />

APB Slave Interface

Control Register 1:

 <img width="865" height="142" alt="image" src="https://github.com/user-attachments/assets/ce75c18a-666d-4514-964d-77566ea5a33a" />

Control Register 2:

 <img width="878" height="150" alt="image" src="https://github.com/user-attachments/assets/20960ef2-9877-4405-aa6b-ec686d84e651" />

Baud rate register:

 <img width="892" height="147" alt="image" src="https://github.com/user-attachments/assets/af3e84d1-1bd2-4025-8b98-5ce3c5a89ba2" />

SPPR2–SPPR0 — SPI Baud Rate Preselection Bits
SPR2–SPR0 — SPI Baud Rate Selection Bits

 <img width="564" height="43" alt="image" src="https://github.com/user-attachments/assets/24a54462-8426-4018-bb5e-4439721c88a5" />

Status Register: (Read only)

 <img width="870" height="146" alt="image" src="https://github.com/user-attachments/assets/4530df9d-683a-481d-ba59-efdcc18d414d" />

Data register:

 <img width="882" height="138" alt="image" src="https://github.com/user-attachments/assets/779a5a07-0bf9-41e7-8f79-68c055017a41" />

Block overview:

 <img width="893" height="484" alt="image" src="https://github.com/user-attachments/assets/23038fb8-b6d3-4051-84c4-9d93f9374694" />



Signal Description:

<img width="914" height="502" alt="image" src="https://github.com/user-attachments/assets/caa0d7fc-aa35-4c39-afd0-5f1cb986b84e" />

<img width="911" height="518" alt="image" src="https://github.com/user-attachments/assets/5802b5c7-7dc8-4813-9ee3-bd6f012e97cb" />


Baud Rate Generator

•	Generates the SPI Serial Clock (sclk)
Converts the high-frequency system clock (PCLK) into a lower-frequency serial clock suitable for SPI communication, based on user-configured baud rate selection (spr and sppr).
•	Calculates Baud Rate Divisor
Computes and outputs a 12-bit BaudRateDivisor value that determines the division factor for generating sclk.
•	Supports SPI Operational Modes
Controls clock behavior according to spi_mode (Run, Wait, Stop) and spiswai (Stop in Wait), enabling power-saving and controlled operation in embedded systems.
•	Handles cpol (Clock Polarity) and cpha (Clock Phase) to align the sclk and data sampling as per SPI mode 0, 1, 2, or 3.
•	Provides Control Flags for Data Timing
o	flag_low / flag_high: Indicate when to receive MISO data based on clock configuration.
o	flags_low / flags_high: Indicate when to send MOSI data based on clock configuration.
These flags synchronize data movement between the SPI controller and the shift register.
•	Ensures data is sampled and transmitted at correct clock edges, depending on the SPI mode, avoiding timing violations and miscommunication.

Block Overview:

 <img width="911" height="600" alt="image" src="https://github.com/user-attachments/assets/4578c2c6-648f-4a26-b08e-e1b3eee26507" />

Signal Description:

 <img width="908" height="623" alt="image" src="https://github.com/user-attachments/assets/c765db14-909a-467e-bfdb-821b4711c5d1" />


Shift register

•	The shift register allows parallel data (8-bit in SPI) to be shifted out serially on the MOSI line during transmission.
•	Simultaneously, it receives serial data from the MISO line and reconstructs it into parallel form.:
•	With each clock cycle, the register shifts data by one bit, either from MSB to LSB or vice versa, depending on the configured bit-order (e.g., LSBFE – Least Significant Bit First Enable).
•	The direction of shifting is configurable to support multiple SPI data formats.
•	Shifting occurs synchronously with the SPI clock (SCK), whose polarity (CPOL) and phase (CPHA) determine the active clock edge for data sampling and shifting.
•	The shift register ensures that 8 bits of data are fully transmitted and received before signalling transfer completion.
•	It also interacts with control logic to manage when to send or latch data.
•	In full-duplex SPI mode, the shift register simultaneously shifts out data on MOSI and shifts in data from MISO, enabling efficient bidirectional communication.



Block Overview:

 <img width="813" height="630" alt="image" src="https://github.com/user-attachments/assets/a64aa66b-b646-474b-a42f-ea66217546bd" />

Signal Description:

 <img width="905" height="615" alt="image" src="https://github.com/user-attachments/assets/82b6afdf-cd15-489d-b6b1-4516e32e9862" />


SPI Slave Control Select 

The SPI Slave Control Block is responsible for managing the control logic required to enable and coordinate SPI data transmission and reception. It serves as a crucial interface between the SPI master/slave logic and other peripheral blocks in the system. The key functionalities of this block are as follows:
1.	Slave Select (SS) Management: The block actively controls the SS (slave select) signal when operating in master mode. It asserts the slave select line (typically active-low) during data transmission, thereby initiating communication with the targeted SPI slave device.
2.	Transfer-In-Progress (TIP) Indication: A tip signal is generated to indicate that a data transfer is currently in progress. This signal remains active throughout the transmission cycle, allowing other modules to monitor SPI bus activity and avoid conflicting operations.
3.	Data Reception Control: The block generates a receive_data signal to enable the shift register to latch incoming data at the appropriate time. This signal is triggered only when valid data is expected from the slave or master, depending on the operating mode.
4.	SPI Mode Configuration: The SPI mode is determined using the spi_mode input, which comprises CPOL (Clock Polarity) and CPHA (Clock Phase) bits. These parameters ensure that data sampling and shifting are synchronized with the appropriate clock edges as defined by the selected SPI mode (0–3).
5.	Master/Slave Role Handling: The mstr input defines whether the SPI is functioning as a master (mstr = 1) or as a slave (mstr = 0). In master mode, the block handles SS control and initiates communication. In slave mode, it responds to external SS assertions.
6.	Baud Rate Synchronization: The block receives the baudratedivisor value, which is used in conjunction with the baud rate generator to synchronize clock timing and data transfer rates.
7.	Software Inhibit Control (SPISWAI): When the spiswai signal is asserted, the SPI interface can be automatically disabled during CPU wait states, contributing to power-saving operations. This is particularly useful in embedded systems with low-power requirements.
8.	Clock and Reset Handling: The operation of the block is synchronous with the system clock (P_clk). A system reset (P_rst) initializes the internal control logic, ensuring a known state upon startup or during fault recovery.






Block Overview:

 <img width="867" height="557" alt="image" src="https://github.com/user-attachments/assets/ec3ed47f-6ecc-4334-9ede-ef48899fcf26" />



Signal description:

 <img width="893" height="417" alt="image" src="https://github.com/user-attachments/assets/175b496f-47da-4510-be43-5b79909835b8" />


 
SPI Top Block
Block Overview:

 <img width="1056" height="503" alt="image" src="https://github.com/user-attachments/assets/d3388fda-4b5a-4c0e-b67c-a76076779c70" />


Conclusion

This SPI project demonstrates a complete Serial Peripheral Interface implementation featuring an integrated APB (Advanced Peripheral Bus) interface. The modular architecture encompasses a baud rate generator, shift register, control logic, and slave select functionality, effectively illustrating synchronous serial communication principles. Comprehensive simulation testing confirms proper SPI protocol operation across multiple modes and configurations, verifying reliable data exchange between master and slave devices.
The project leverages the Verilog RTL design methodology, coupled with testbench verification, to solidify an understanding of digital design fundamentals, hardware interfacing techniques, and communication protocol development. This work establishes a robust foundation for advancing into embedded systems design, intellectual property core creation, and sophisticated VLSI engineering applications.
